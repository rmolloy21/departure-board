<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>London Departure Board — Prototype</title>

  <style>
    :root{
      --bg: #0b0d10;
      --card: #12161c;
      --muted: #9aa4b2;
      --text: #e7eef8;
      --accent: #ffd400; /* departure-board yellow */
      --line: #2a3240;
      --danger: #ff6b6b;
      --ok: #4ade80;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg: #f6f7fb;
        --card: #ffffff;
        --muted: #556273;
        --text: #0b1220;
        --line: #e6eaf0;
        --accent: #111827;
      }
    }

    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .phone{
      max-width: 430px;
      margin: 0 auto;
      padding: 14px 14px 28px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .title{ line-height:1.1; }
    .title h1{
      font-size: 18px;
      margin: 4px 0 2px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
    }
    .controls{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    select, button{
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      outline:none;
    }
    button{ cursor:pointer; }
    button.primary{
      border-color: transparent;
      background: var(--accent);
      color: #0b0d10;
      font-weight: 800;
    }
    .pill{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      background: rgba(255,255,255,0.02);
    }
    .dot{
      width:8px; height:8px; border-radius:999px; background: var(--muted);
      display:inline-block;
    }

    .boards{
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 10px;
    }
    .board{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }

    /* ===== Board header styling (dark navy tint) ===== */
    .boardHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      background: rgba(9, 18, 38, 0.65);
    }
    @media (prefers-color-scheme: light) {
      .boardHeader{
        background: rgba(240, 243, 248, 1);
      }
    }

    .boardHeader .left{ min-width: 0; }
    .boardHeader .name{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: 0.2px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .boardHeader .meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      opacity: 0.95;
    }
    .boardHeader .right{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      min-width: 140px;
    }
    .smallBtn{
      font-size: 12px;
      padding: 7px 9px;
      border-radius: 10px;
    }

    /* ===== Compact per-board line dropdown ===== */
    .lineSelect{
      width: 100%;
      font-size: 12px;
      padding: 7px 8px;
      border-radius: 10px;
    }

    /* ===== More compact departure rows ===== */
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12.5px;
    }
    .table td{
      padding: 8px 12px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    .table tr:last-child td{ border-bottom:none; }

    .dest{ font-weight: 800; margin-bottom: 1px; }
    .subline{
      color: var(--muted);
      font-size: 11px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .time{
      text-align:right;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
      font-weight: 900;
      width: 1%;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
    }
    .warn{ color: var(--danger); font-weight: 700; }
    .ok{ color: var(--ok); font-weight: 700; }
    .footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: 11.5px;
      line-height:1.35;
    }
    a{ color: inherit; }

    /* ===== Station search modal ===== */
    .modalBackdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:999;
      padding: 10px;
    }
    .modal{
      background: #111;
      max-width: 430px;
      margin: 10vh auto;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    @media (prefers-color-scheme: light) {
      .modal{
        background: #fff;
        border: 1px solid rgba(0,0,0,0.08);
      }
    }
    .modalRow{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      align-items:center;
    }
    .modalInput{
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.12);
      font-size:16px;
      outline:none;
      background: rgba(255,255,255,0.06);
      color: var(--text);
    }
    @media (prefers-color-scheme: light) {
      .modalInput{
        background: #f6f7fb;
        border: 1px solid rgba(0,0,0,0.1);
        color: #0b1220;
      }
    }
    .resultItem{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,0.12);
      cursor:pointer;
    }
    @media (prefers-color-scheme: light) {
      .resultItem{
        border-bottom:1px solid rgba(0,0,0,0.08);
      }
    }
    .resultItem:last-child{ border-bottom:none; }
    .resultItem small{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="phone">
    <header>
      <div class="title">
        <h1>London Departure Board</h1>
        <div class="sub" id="statusText">Idle</div>
      </div>
      <div class="controls">
        <div class="row">
          <select id="displayMode">
            <option value="countdown">Live (mins)</option>
            <option value="clock">Snapshot (HH:MM)</option>
          </select>
        </div>
        <div class="row">
          <button class="smallBtn" id="refreshBtn">Refresh</button>
          <button class="primary smallBtn" id="settingsBtn">Favourites</button>
        </div>
      </div>
    </header>

    <div class="pill">
      <span class="dot" id="pulseDot"></span>
      <span>Auto-refresh: <strong id="refreshEvery">25s</strong> (while page open)</span>
    </div>

    <div class="boards">
      <section class="board" id="boardFav1">
        <div class="boardHeader">
          <div class="left">
            <div class="name" id="fav1Name">Favourite #1</div>
            <div class="meta"><span id="fav1Meta">Not set</span></div>
          </div>
          <div class="right">
            <select class="lineSelect" id="fav1Line">
              <option value="all">All lines</option>
            </select>
            <button class="smallBtn" data-pick="fav1">Set</button>
          </div>
        </div>
        <table class="table" id="fav1Table"></table>
      </section>

      <section class="board" id="boardFav2">
        <div class="boardHeader">
          <div class="left">
            <div class="name" id="fav2Name">Favourite #2</div>
            <div class="meta"><span id="fav2Meta">Not set</span></div>
          </div>
          <div class="right">
            <select class="lineSelect" id="fav2Line">
              <option value="all">All lines</option>
            </select>
            <button class="smallBtn" data-pick="fav2">Set</button>
          </div>
        </div>
        <table class="table" id="fav2Table"></table>
      </section>

      <section class="board" id="boardNear">
        <div class="boardHeader">
          <div class="left">
            <div class="name" id="nearName">Nearest station</div>
            <div class="meta">
              <span id="nearMeta">Needs location permission</span>
            </div>
          </div>
          <div class="right">
            <select class="lineSelect" id="nearLine">
              <option value="all">All lines</option>
            </select>
            <button class="smallBtn" id="locBtn">Use location</button>
          </div>
        </div>
        <table class="table" id="nearTable"></table>
      </section>
    </div>

    <div class="hint">
      Tip: “Snapshot (HH:MM)” simulates your widget approach: show <strong>clock times</strong> instead of “2 mins”.
    </div>

    <div class="footer">
      Not affiliated with or endorsed by Transport for London. Data from TfL.
    </div>
  </div>

  <!-- Station Search Modal -->
  <div id="searchModal" class="modalBackdrop">
    <div class="modal">
      <div class="modalRow">
        <input
          id="stationSearchInput"
          class="modalInput"
          placeholder="Search station (e.g. Woolwich)"
          oninput="debouncedStationSearch(this.value)"
        >
        <button class="smallBtn" onclick="closeSearch()">✕</button>
      </div>
      <div id="searchResults"></div>
    </div>
  </div>

<script>
/**
 * London Departure Board Prototype
 * - Frontend on GitHub Pages
 * - Backend via Cloudflare Worker:
 *   GET /stations/search?q=...
 *   GET /arrivals?stopPointId=...
 */

// ========== CONFIG ==========
const API_BASE = "https://departure-board-api.ryancmolloy.workers.dev"; // no trailing slash
const AUTO_REFRESH_SECONDS = 25;
const MAX_ROWS = 4;

// Minimal station list used ONLY for nearest-station demo.
// (Favourites use live search via API.)
const STATIONS = [
  { name: "Woolwich (Elizabeth line)", id: "910GWOLWXR", lat: 51.4919, lon: 0.0712 },
  { name: "Canary Wharf (Elizabeth line)", id: "910GCANWHRF", lat: 51.5036, lon: -0.0199 },
  { name: "Liverpool Street", id: "910GLIVST", lat: 51.5178, lon: -0.0824 },
  { name: "Paddington", id: "910GPADTON", lat: 51.5154, lon: -0.1755 },
  { name: "Waterloo", id: "910GWATRLMN", lat: 51.5033, lon: -0.1147 },
  { name: "London Bridge", id: "910GLNDBRDG", lat: 51.5054, lon: -0.0865 },
];

const STORAGE_KEYS = {
  fav1Id: "ldb_fav1_stopPointId",
  fav1Name: "ldb_fav1_name",
  fav2Id: "ldb_fav2_stopPointId",
  fav2Name: "ldb_fav2_name",

  fav1Line: "ldb_fav1_line",
  fav2Line: "ldb_fav2_line",
  nearLine: "ldb_near_line"
};

// ========== STATE ==========
let nearestStop = null;
let timer = null;
let lastUpdated = null;

// ========== ELEMENTS ==========
const statusText = document.getElementById("statusText");
const pulseDot = document.getElementById("pulseDot");
const refreshBtn = document.getElementById("refreshBtn");
const settingsBtn = document.getElementById("settingsBtn");
const locBtn = document.getElementById("locBtn");
const displayMode = document.getElementById("displayMode");
document.getElementById("refreshEvery").textContent = `${AUTO_REFRESH_SECONDS}s`;

const els = {
  fav1Name: document.getElementById("fav1Name"),
  fav1Meta: document.getElementById("fav1Meta"),
  fav1Table: document.getElementById("fav1Table"),
  fav2Name: document.getElementById("fav2Name"),
  fav2Meta: document.getElementById("fav2Meta"),
  fav2Table: document.getElementById("fav2Table"),
  nearName: document.getElementById("nearName"),
  nearMeta: document.getElementById("nearMeta"),
  nearTable: document.getElementById("nearTable"),
};

const boardLineSelect = {
  fav1: document.getElementById("fav1Line"),
  fav2: document.getElementById("fav2Line"),
  near: document.getElementById("nearLine"),
};

// Restore saved line selections
boardLineSelect.fav1.value = localStorage.getItem(STORAGE_KEYS.fav1Line) || "all";
boardLineSelect.fav2.value = localStorage.getItem(STORAGE_KEYS.fav2Line) || "all";
boardLineSelect.near.value = localStorage.getItem(STORAGE_KEYS.nearLine) || "all";

// Save selection + refresh
boardLineSelect.fav1.addEventListener("change", () => {
  localStorage.setItem(STORAGE_KEYS.fav1Line, boardLineSelect.fav1.value);
  refreshAll(true);
});
boardLineSelect.fav2.addEventListener("change", () => {
  localStorage.setItem(STORAGE_KEYS.fav2Line, boardLineSelect.fav2.value);
  refreshAll(true);
});
boardLineSelect.near.addEventListener("change", () => {
  localStorage.setItem(STORAGE_KEYS.nearLine, boardLineSelect.near.value);
  refreshAll(true);
});

// Set buttons open station search
for (const btn of document.querySelectorAll("button[data-pick]")) {
  btn.addEventListener("click", () => openSearch(btn.dataset.pick));
}

refreshBtn.addEventListener("click", () => refreshAll(true));
settingsBtn.addEventListener("click", () => openFavouritesHelp());
locBtn.addEventListener("click", () => setNearestFromLocation());
displayMode.addEventListener("change", () => refreshAll(true));

// ========== HELPERS ==========
function setStatus(msg) { statusText.textContent = msg; }
function pulse(active) { pulseDot.style.background = active ? "var(--ok)" : "var(--muted)"; }

function fmtClock(dt) {
  const d = new Date(dt);
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}
function minutesFromNow(dt) {
  const ms = new Date(dt).getTime() - Date.now();
  const mins = Math.round(ms / 60000);
  return mins <= 0 ? "Due" : `${mins} min`;
}
function haversineMeters(aLat, aLon, bLat, bLon) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(bLat - aLat);
  const dLon = toRad(bLon - aLon);
  const lat1 = toRad(aLat);
  const lat2 = toRad(bLat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function getFavId(which) {
  return localStorage.getItem(STORAGE_KEYS[`${which}Id`]) || null;
}
function getFavName(which) {
  return localStorage.getItem(STORAGE_KEYS[`${which}Name`]) || null;
}
function setFav(which, stopPointId, stationName) {
  localStorage.setItem(STORAGE_KEYS[`${which}Id`], stopPointId);
  localStorage.setItem(STORAGE_KEYS[`${which}Name`], stationName || stopPointId);
}

function stationById(id) {
  return STATIONS.find(s => s.id === id) || { name: id, id };
}

// ========== API ==========
async function fetchArrivals(stopPointId) {
  const url = `${API_BASE}/arrivals?stopPointId=${encodeURIComponent(stopPointId)}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);

  const payload = await res.json();
  const data = Array.isArray(payload.arrivals) ? payload.arrivals : [];
  data.sort((a,b) => new Date(a.expectedArrival) - new Date(b.expectedArrival));
  return data;
}

function getLineKey(item) {
  return (item.lineId || item.lineName || "unknown").toLowerCase();
}

function buildBoardLineOptions(selectEl, arrivals) {
  if (!selectEl) return;

  const current = selectEl.value || "all";
  const seen = new Map();

  for (const it of arrivals || []) {
    const key = getLineKey(it);
    const display = it.lineName || it.lineId || "Unknown";
    if (!seen.has(key)) seen.set(key, display);
  }

  selectEl.innerHTML = `<option value="all">All lines</option>`;
  [...seen.entries()]
    .sort((a,b) => a[1].localeCompare(b[1]))
    .forEach(([key, display]) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = display;
      selectEl.appendChild(opt);
    });

  const exists = [...selectEl.options].some(o => o.value === current);
  selectEl.value = exists ? current : "all";
}

// ========== RENDER ==========
function renderTable(tableEl, items) {
  tableEl.innerHTML = "";
  if (!items || items.length === 0) {
    tableEl.innerHTML = `<tr><td><span class="warn">No departures found.</span><div class="subline">Try “All lines” or refresh.</div></td><td class="time">—</td></tr>`;
    return;
  }

  const mode = displayMode.value; // countdown | clock

  for (const it of items.slice(0, MAX_ROWS)) {
    const dest = it.destinationName || it.towards || "Unknown destination";
    const lineName = it.lineName || it.lineId || "Unknown line";
    const platform = it.platformName ? `Plat: ${it.platformName}` : null;

    const timeText = (mode === "clock") ? fmtClock(it.expectedArrival) : minutesFromNow(it.expectedArrival);
    const subBits = [lineName];
    if (platform) subBits.push(platform);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div class="dest">${escapeHtml(dest)}</div>
        <div class="subline">${subBits.map(escapeHtml).join(" · ")}</div>
      </td>
      <td class="time">${escapeHtml(timeText)}</td>
    `;
    tableEl.appendChild(tr);
  }
}

// ========== STATION SEARCH MODAL ==========
let activeFavouriteSlot = null;
let searchTimer = null;

function openSearch(slot) {
  activeFavouriteSlot = slot;
  document.getElementById("searchModal").style.display = "block";
  document.getElementById("stationSearchInput").value = "";
  document.getElementById("searchResults").innerHTML = "";
  document.getElementById("stationSearchInput").focus();
}

function closeSearch() {
  document.getElementById("searchModal").style.display = "none";
  activeFavouriteSlot = null;
}

function debouncedStationSearch(q) {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => searchStations(q), 250);
}

async function searchStations(q) {
  q = (q || "").trim();
  if (q.length < 2) {
    document.getElementById("searchResults").innerHTML = "";
    return;
  }

  const res = await fetch(`${API_BASE}/stations/search?q=${encodeURIComponent(q)}`, { cache: "no-store" });
  if (!res.ok) {
    document.getElementById("searchResults").innerHTML = `<div class="warn">Search failed (HTTP ${res.status})</div>`;
    return;
  }

  const data = await res.json();
  const results = Array.isArray(data.matches) ? data.matches : [];

  if (results.length === 0) {
    document.getElementById("searchResults").innerHTML = `<div class="hint">No results.</div>`;
    return;
  }

  document.getElementById("searchResults").innerHTML = results.slice(0, 12).map(r => `
    <div class="resultItem" onclick="selectStation('${r.id}','${String(r.name).replace(/'/g, "\\'")}')">
      <strong>${escapeHtml(r.name)}</strong><br>
      <small>${escapeHtml((r.modes || []).join(", "))}</small>
    </div>
  `).join("");
}

function selectStation(id, name) {
  if (!activeFavouriteSlot) return;
  setFav(activeFavouriteSlot, id, name);
  closeSearch();
  refreshAll(true);
}

function openFavouritesHelp() {
  alert("Tap Set on Favourite #1 or #2, then search and select a station.\n\nLine filters are per-board on the right.");
}

// ========== LOCATION ==========
function setNearestFromLocation() {
  if (!navigator.geolocation) {
    els.nearMeta.textContent = "Geolocation not supported";
    return;
  }
  setStatus("Getting location…");
  pulse(true);

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      const { latitude, longitude } = pos.coords;
      let best = null;
      let bestD = Infinity;

      for (const s of STATIONS) {
        const d = haversineMeters(latitude, longitude, s.lat, s.lon);
        if (d < bestD) { bestD = d; best = s; }
      }

      nearestStop = best;
      els.nearName.textContent = best.name;
      els.nearMeta.textContent = `~${Math.round(bestD)}m away`;
      await refreshAll(true);
    },
    (err) => {
      els.nearMeta.textContent = `Location denied (${err.code})`;
      setStatus("Idle");
      pulse(false);
    },
    { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 }
  );
}

// ========== MAIN REFRESH ==========
async function refreshAll(manual=false) {
  const fav1 = getFavId("fav1");
  const fav2 = getFavId("fav2");
  const fav1Name = getFavName("fav1");
  const fav2Name = getFavName("fav2");

  // Headers + empty states
  if (fav1) {
    els.fav1Name.textContent = fav1Name || "Favourite #1";
    els.fav1Meta.textContent = lastUpdated ? `Last updated ${fmtClock(lastUpdated)}` : "—";
  } else {
    els.fav1Name.textContent = "Favourite #1";
    els.fav1Meta.textContent = "Not set";
    els.fav1Table.innerHTML = `<tr><td>Tap <strong>Set</strong> to choose a station.</td><td class="time">—</td></tr>`;
  }

  if (fav2) {
    els.fav2Name.textContent = fav2Name || "Favourite #2";
    els.fav2Meta.textContent = lastUpdated ? `Last updated ${fmtClock(lastUpdated)}` : "—";
  } else {
    els.fav2Name.textContent = "Favourite #2";
    els.fav2Meta.textContent = "Not set";
    els.fav2Table.innerHTML = `<tr><td>Tap <strong>Set</strong> to choose a station.</td><td class="time">—</td></tr>`;
  }

  if (!nearestStop) {
    els.nearName.textContent = "Nearest station";
    els.nearTable.innerHTML = `<tr><td>Tap <strong>Use location</strong> to set nearest station.</td><td class="time">—</td></tr>`;
  }

  const ids = [
    { key: "fav1", id: fav1, table: els.fav1Table },
    { key: "fav2", id: fav2, table: els.fav2Table },
    { key: "near", id: nearestStop?.id || null, table: els.nearTable },
  ].filter(x => x.id);

  if (ids.length === 0) {
    setStatus("Idle");
    pulse(false);
    return;
  }

  setStatus(manual ? "Refreshing…" : "Auto-refreshing…");
  pulse(true);

  try {
    const results = await Promise.all(ids.map(x => fetchArrivals(x.id)));

    for (let i = 0; i < ids.length; i++) {
      const boardKey = ids[i].key;
      const arrivals = results[i];

      // Populate per-board line dropdown
      buildBoardLineOptions(boardLineSelect[boardKey], arrivals);

      // Apply per-board selection
      const selected = boardLineSelect[boardKey]?.value || "all";
      let items = arrivals;
      if (selected !== "all") {
        items = items.filter(it => getLineKey(it) === selected);
      }

      renderTable(ids[i].table, items);
    }

    lastUpdated = new Date();
    // refresh header meta now that we have lastUpdated
    if (fav1) els.fav1Meta.textContent = `Last updated ${fmtClock(lastUpdated)}`;
    if (fav2) els.fav2Meta.textContent = `Last updated ${fmtClock(lastUpdated)}`;
    if (nearestStop) els.nearMeta.textContent = els.nearMeta.textContent || `Last updated ${fmtClock(lastUpdated)}`;

    setStatus(`Updated ${fmtClock(lastUpdated)} · mode: ${displayMode.value}`);
  } catch (e) {
    setStatus("Update failed");
    for (const x of ids) {
      x.table.innerHTML = `<tr><td><span class="warn">Couldn’t load departures.</span><div class="subline">${escapeHtml(e.message || e)}</div></td><td class="time">—</td></tr>`;
    }
  } finally {
    pulse(false);
  }
}

// Start auto refresh
function startTimer() {
  if (timer) clearInterval(timer);
  timer = setInterval(() => refreshAll(false), AUTO_REFRESH_SECONDS * 1000);
}

// Initial paint
refreshAll(false);
startTimer();
</script>

</body>
</html>
